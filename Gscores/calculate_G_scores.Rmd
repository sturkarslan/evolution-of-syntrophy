---
title: "Calculate G-score for Syntrophy Evolution"
output: html_notebook
---
### calculate G-score based on the https://www.nature.com/articles/nature18959#s1.

Li: length of protein-coding gene.

Ni: the number of independent nonsynonymous mutations observed in that gene across all clones.

Ltot: summed length of all protein-coding genes in the ancestral genome.

Ntot: summed total number of nonsynonymous mutations in these genes.

Ei: expected number of non-synonymous mutations for a given gene.

Ei = Ntot(Li/Ltot).

Goodness of fit score: Gi = 2Niloge(Ni/Ei).

```{r}
library('ggplot2'); library('reshape2');library(gridExtra);library(gplots)
source("~/Google Drive File Stream/My Drive/R_Scripts/extractLegend.R")
source('load_1K_mutation_data.R')
```

Load mutation data
```{r}
mut.data.dv <- load_1K_mutation_data(include.ancestor = F,organism = "Desulfovibrio")
mut.data.dv <- mut.data.dv$all.mutations
mut.data.dv$organism <- "Desulfovibrio"
#length(mut.data.dv$variant_id) # 3873
#length(unique(mut.data.dv$variant_id)) # 304
mut.type <- melt(table(mut.data.dv$mutation))
mut.effect <- melt(table(mut.data.dv$effect))
p1 <- ggplot(mut.type, aes(factor(Var1, levels = mut.type[order(mut.type$value, decreasing = T),"Var1"]), value, fill=Var1))
p1 <- p1 + geom_bar(stat="identity")
p1 <- p1 + geom_label(aes(label=value))  
p1 <- p1 + theme(axis.text = element_blank())
p1 <- p1 + labs(x = "Mutations", y = "Count")
p1
```

```{r}
mut.effect <- melt(table(mut.data.dv$effect))
p2 <- ggplot(mut.effect, aes(factor(Var1, levels = mut.effect[order(mut.effect$value, decreasing = T),"Var1"]), value, fill=Var1))
p2 <- p2 + geom_bar(stat="identity")
p2 <- p2 + geom_label(aes(label=value))  
p2 <- p2 + theme(axis.text = element_blank())
p2 <- p2 + labs(x = "Effect", y = "Count")
p2
```


### get all mutations except synonymous and intergenic
``` {r}
mutations.1000.na <- load_1K_mutation_data(include.ancestor = F,organism = "Desulfovibrio")
mutations.1000.na <- mutations.1000.na$mutations.1K.na
```

### load dvh genome features file and collect only genes
```{r}
dvh.genome <- read.delim("~/Google Drive File Stream/My Drive/Manuscripts/Syntrophy-SingleCell/GenomeFiles/GCF_000195755.1_ASM19575v1_feature_table.txt",
                         header = T, sep="\t", stringsAsFactors=F)
# collect only genes
dvh.genes <- dvh.genome[which(dvh.genome$X..feature == "gene"),]
dvh.cds <- dvh.genome[which(dvh.genome$X..feature == "CDS" | dvh.genome$X..feature == "tRNA" | dvh.genome$X..feature == "rRNA" | dvh.genome$X..feature == "misc_RNA"),]

```

### Calculate G-core for all mutations except low and modifier
``` {r calculate}
##### all mutations except low and modifier forDv
# calculate total coding length (Ltot)
Ltot <- sum(dvh.genes$feature_interval_length) #3313981
# get all mutations except synonymous and intergenic
all.mutations <- mutations.1000.na[which(mutations.1000.na$effect == "HIGH" | mutations.1000.na$effect == "MODERATE"),]
frameshift.mutations <- mutations.1000.na[grep("FRAME_SHIFT", mutations.1000.na$mutation),]
length(frameshift.mutations$variant_id) #56
syncoding.mutations <- mutations.1000.na[which(mutations.1000.na$mutation == "SYNONYMOUS_CODING"),]
length((syncoding.mutations$variant_id)) # 4

Ntot <- length(all.mutations$variant_id)
cat("Total # of mutations:", Ntot,"\n")
cat("Total coding lenght:", Ltot, "\n")

# create a G-score table
all.table <- data.frame()
for(gene in dvh.genes$GeneID){
  locus <- dvh.genes[which(dvh.genes$GeneID == gene), "locus_tag"]
  locus <- sub("DVUA", "DVKA", locus)
  locus <- sub("DVU", "DVU_", locus)
  locus <- sub("DVKA", "DVUA", locus)
  name <- dvh.cds[which(dvh.cds$GeneID == gene), "name"]
  symbol <- dvh.genes[which(dvh.genes$GeneID == gene), "symbol"]
  
  Li <- dvh.genes[which(dvh.genes$GeneID == gene),"feature_interval_length"]
  Ni <- length(all.mutations[which(all.mutations$gene_id == locus),"variant_id"])
  Nframeshift <- length(frameshift.mutations[which(frameshift.mutations$gene_id == locus),"variant_id"])
  Nsynonymous <- length(syncoding.mutations[which(syncoding.mutations$gene_id == locus),"variant_id"])
  # calculate expected number of mutations
  Ei <- Ntot*(Li/Ltot)
  # calculate GScore
  Gscore <- 2*Ni*log1p(Ni/Ei)
  # # add ancestor annotation
  # if(locus %in% ancestor.mutated.genes){
  #   ancestor = "ancestral"
  # }else{
  #   ancestor = "non-ancestral"
  # }
  all.table <- rbind(all.table, cbind(locus=locus,
                                      symbol= if(length(symbol !=0)) {paste(symbol)}else{paste("")},
                                      name=if(length(name !=0)) {paste(name)}else{paste("")},
                                      Length=Li,
                                      observed=Ni,
                                      expected=Ei,
                                      Gscore=Gscore,
                                      Nframeshift=Nframeshift,
                                      Nsynonymous=Nsynonymous
                                      ))
  cat(gene, locus, Li, Ni, Ei, "\n")
}

# sort table based on Gscores
all.table <- all.table[order(as.numeric(as.character(all.table$Gscore)), decreasing = T ),]
sum.gscores <- sum(as.numeric(as.character(all.table$Gscore))) # 1092.617
cat("Sum of Observed G-scores:", sum.gscores, "\n")

# write results into a table
write.table(all.table, file="Gscores_high_moderate_dvh.txt", sep="\t")
```

